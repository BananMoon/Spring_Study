# ëª©ì°¨
- Spring MVC
- JPA

---

## Spring MVC
### @ModelAttribute
- ê¸°ë³¸ì ìœ¼ë¡œ controller ë‹¨ì—ì„œ argumentì— ì–´ë…¸í…Œì´ì…˜ì´ ìƒëµë˜ì–´ìˆì„ ê²½ìš°,
  - String, int, Integer ê°™ì€ **ë‹¨ìˆœ íƒ€ì…**ì€ `@RequestParam`ì„ ë¶™ì¸ ê²ƒì²˜ëŸ¼ ë™ì‘í•˜ê³  
  - ë‚˜ë¨¸ì§€(ì˜ˆë¥¼ ë“¤ë©´ í´ë˜ìŠ¤ ê°ì²´)ëŠ” `@ModelAttribute`ë¥¼ ë¶™ì¸ ê²ƒì²˜ëŸ¼ ë™ì‘í•©ë‹ˆë‹¤.

### Formê³¼ Entityì˜ êµ¬ë¶„
- (ë³µì¡í•˜ë©´ ë³µì¡í• ìˆ˜ë¡) ê¸°ì¡´ì— ìƒì„±í•œ Entityì™€ ì›¹ì—ì„œ ì „ë‹¬ë˜ëŠ” ë°ì´í„°ê°€ ì™„ë²½íˆ ë§¤ì¹­ë  ìˆ˜ ì—†ëŠ” ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ë‹¤.
  - ì¦‰, ìˆœìˆ˜ Entityì˜ í•„ë“œë“¤ì—, í™”ë©´ì— í•„ìš”í•œ ë°ì´í„°ë“¤ì´ ì¶”ê°€ë¡œ ì¡´ì¬í•œë‹¤. 
- ê·¸ë ‡ë‹¤ê³  í•„ìš”í•œ ë°ì´í„°ë“¤ì„ Entityì— ëª¨ë‘ êµ¬í˜„í•˜ê²Œ ë˜ë©´, EntityëŠ” ì›¹ì— ì¢…ì†ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
- EntityëŠ” ìˆœìˆ˜(í•µì‹¬) ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ í¬í•¨í•˜ëŠ” ê°ì²´ë¡œ ë‘ì–´ì•¼í•˜ê³ , ë”°ë¡œ í™”ë©´ì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ì „ë‹¬í•  ê°ì²´ë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤. 
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— Form ê°ì²´ë¥¼ ë”°ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì„ ê¶Œê³ í•œë‹¤.

`Formê³¼ DTOì˜ êµ¬ë¶„`ì€ Formë³´ë‹¤ ë„“ì€ ë²”ìœ„ê°€ DTOì´ë‹¤.
  - Formì€ ì›¹ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì— ì „ë‹¬ë  ë•Œ ì‚¬ìš©ë˜ëŠ” ê²ƒìœ¼ë¡œ í•œì •ëœ ì˜ë¯¸ì˜ ê°ì²´ì´ê³ , DTOëŠ” ëª¨ë“  Layerì—ì„œ ê°ì²´ë¥¼ ì „ë‹¬í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤.
  - ë„¤ì´ë° ì°¨ì´ì— ë”°ë¼ ë‹¤ë¥¸ ê³³ì—ì„œ ì“°ì´ëŠ” ê²ƒì´ì§€, ì—­í• ì€ ë™ì¼í•˜ë‹¤. 
> Setterë¥¼ ì—´ì–´ì¤˜ë„ ë˜ëŠ”ê°€?<br>
> Formì€ Viewë‹¨ê³¼ ì—°ê²°ë˜ì–´ ì“°ì´ê¸° ë•Œë¬¸ì— getter, setterë¥¼ ì´ìš©í•´ì„œ ì ‘ê·¼í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤. ê·¸ë¦¬ê³  Entity ìì²´ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— Setterë¥¼ ì—´ì–´ì¤˜ë„ ê´œì°®ë‹¤. 
 
---

## JPA
#### ëª¨ë“  ì—°ê´€ê´€ê³„ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ì! ğŸ’›
- ì¦‰ì‹œë¡œë”©(`EAGER`)ì€ ì˜ˆì¸¡ì´ ì–´ë µê³  ì–´ë–¤ SQLì´ ì‹¤í–‰ë ì§€ ì¶”ì í•˜ê¸° ì–´ë µë‹¤. íŠ¹íˆ `JPQL`ì„ ì‹¤í–‰í•  ë•Œ `N+1` ë¬¸ì œê°€ ìì£¼ ë°œìƒí•œë‹¤.
- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ DBì—ì„œ ì¡°íšŒí•´ì•¼ í•˜ë©´, ì¦‰ì‹œë¡œë”©(`EAGER`)ë¡œ ì„¤ì •í•˜ê¸° ë³´ë‹¤ **fetch join** ë˜ëŠ” **ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥**ì„ ì‚¬ìš©í•˜ì.
- `@ManyToOne`, `@OneToOne`ì€ ì¦‰ì‹œë¡œë”©ì´ default.
---

#### Entity Manager Factoryì™€ EntityManager ğŸ’“
- EntityManagerFactoryëŠ” EntityManagerë¥¼ ë§Œë“œëŠ” ì—­í• ì„ í•œë‹¤.
- EntityManagerFactoryë¥¼ ë§Œë“œëŠ” ë¹„ìš©ì€ ìƒë‹¹íˆ í¬ë‹¤.
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì ‘ê·¼í•´ë„ ì•ˆì „í•˜ë‹¤.
- EntityManagerëŠ” ì—”í‹°í‹°ë¥¼ ìˆ˜ì •/ì‚­ì œ/ì¡°íšŒ ë“± ì¼ì„ ì²˜ë¦¬í•˜ëŠ”ë°, ë§ ê·¸ëŒ€ë¡œ ì—”í‹°í‹° ê´€ë¦¬ì ì´ë‹¤.
- EntityManagerë¥¼ ìƒì„±í•˜ëŠ” ë¹„ìš©ì€ ê±°ì˜ ë“¤ì§€ ì•Šì§€ë§Œ, ìŠ¤ë ˆë“œê°€ ë™ì‹œ ì ‘ê·¼í•˜ë©´ ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ ìŠ¤ë ˆë“œ ê°„ ì ˆëŒ€ ê³µìœ í•´ì„œëŠ” ì•ˆëœë‹¤.


- EntityManagerëŠ” íŠ¸ëœì­ì…˜ì´ ì‹œì‘í•  ë•Œì™€ ê°™ì´ db ì—°ê²°ì´ ê¼­ í•„ìš”í•œ ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ íšë“í•œë‹¤.
- EntityManagerFactoryë¥¼ ìƒì„±í•˜ëŠ” ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜í’€ë„ ìƒì„±í•œë‹¤.
---

#### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ (Persistence Context) ğŸ¤
- ì—”í‹°í‹°ë¥¼ 'ì˜êµ¬ ì €ì¥'í•˜ëŠ” í™˜ê²½ì´ë¼ëŠ” ëœ»ìœ¼ë¡œ, ì—”í‹°í‹° ë§¤ë‹ˆì €ë¡œ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ê±°ë‚˜ ì¡°íšŒ ì‹œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ë¥¼ ë³´ê´€í•˜ê³  ê´€ë¦¬í•œë‹¤.
- ì•„ë˜ ì½”ë“œëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ëŠ” ì½”ë“œì´ë‹¤.
`EntityManagerê°ì²´.persist(ì—”í‹°í‹°)`
- ì—¬ëŸ¬ ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ê°™ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ë„, í•˜ë‚˜ì˜ ì—”í‹°í‹° ë§¤ë‹ˆì €ì— í•˜ë‚˜ì˜ ì˜ì†ì„± ë¨¼í…ìŠ¤íŠ¸ê°€ ìƒì„±ë  ìˆ˜ë„ ìˆë‹¤.

- íŠ¹ì§•
1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì—”í‹°í‹°ë¥¼ ì‹ë³„ìê°’ìœ¼ë¡œ êµ¬ë¶„í•˜ê¸° ë•Œë¬¸ì— ì‹ë³„ì ê°’ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•œë‹¤. (ì•ˆê·¸ëŸ¬ë©´ ì˜ˆì™¸ ë°œìƒ)
2. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìƒˆë¡œ ì €ì¥ëœ ì—”í‹°í‹°ëŠ” íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ëŠ” ìˆœê°„ DBì— flushëœë‹¤.
- ì¥ì 
1. 1ì°¨ ìºì‹œ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— (ì‹ë³„ì,ì—”í‹°í‹° ì¸ìŠ¤í„´ìŠ¤) í˜•íƒœë¡œ Map ìë£Œêµ¬ì¡°ë¡œ ì¡´ì¬í•˜ëŠ” ìºì‹œ ê³µê°„
- 1ì°¨ ìºì‹œì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´, DBì—ì„œ ê°€ì ¸ì™€ì„œ 1ì°¨ ìºì‹œì— ì €ì¥í•œ í›„ ë°˜í™˜í•œë‹¤.
2. ë™ì¼ì„± ë³´ì¥
- ì¡°íšŒ ì‹œ 1ì°¨ ìºì‹œì— ì €ì¥ëœ ì—”í‹°í‹°ë“¤ì„ ì¡°íšŒí•˜ê¸° ë•Œë¬¸ì— ê°™ì€ ì—”í‹°í‹°ê°€ ì¡°íšŒë˜ë¯€ë¡œ ë™ì¼ì„±ì´ ë³´ì¥ëœë‹¤.
3. íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—°(Lazy)
4. ë³€ê²½ ê°ì§€
- ì—”í‹°í‹°ê°€ ì²˜ìŒ 1ì°¨ ìºì‹œì— ì €ì¥ë  ë•Œ JPAëŠ” ìµœì´ˆ ìƒíƒœë¥¼ ë³µì‚¬í•´ì„œ ì €ì¥í•´ë‘”ë‹¤. (ìŠ¤ëƒ…ìƒ·)
- (í”ŒëŸ¬ì‹œ ì‹œì ) íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë  ë•Œë§ˆë‹¤ ê·¸ ìŠ¤ëƒ…ìƒ·ê³¼ ì—”í‹°í‹°ë¥¼ ë¹„êµí•´ì„œ ë³€ê²½ëœ ì—”í‹°í‹°ë¥¼ ì°¾ëŠ”ë‹¤.  (ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ì—ë§Œ ì ìš©)
- ìˆë‹¤ë©´ update sqlë¬¸ì„ ìƒì„±í•´ì„œ **ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œ**ì— ë³´ë‚¸ë‹¤. ì´ ì €ì¥ì†Œì˜ SQLì„ DBì— ë³´ë‚¸ë‹¤.
- DB íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹(í”ŒëŸ¬ì‹œ)í•œë‹¤. ì´ë•Œ ëª¨ë“  í•„ë“œê°€ ë‹¤ì‹œ updateëœë‹¤. (BUT, ì¼ë¶€ í•„ë“œë§Œ ì—…ë°ì´íŠ¸ë˜ëŠ” ê²Œ ë” ì¥ì ì¸ ìƒí™©ì´ë¼ë©´ ì „ëµì„ ìˆ˜ì •í•˜ë©´ ëœë‹¤.)
- ì¼ë¶€ í•„ë“œë§Œ ë³€ê²½ë˜ê¸° ì›í•˜ë©´ `@org.hibernate.annotations.DynamicUpdate`
5. ì§€ì—° ë¡œë”©
---

#### í”ŒëŸ¬ì‹œ(flush()) ğŸ’œ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ ë‚´ìš©ì„ DBì— ë°˜ì˜í•œë‹¤.
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í”ŒëŸ¬ì‹œí•˜ëŠ” ë°©ë²• 3ê°€ì§€
1. ì§ì ‘ í˜¸ì¶œ : `em.flush()`
- ê±°ì˜ ì‚¬ìš© X
2. íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ í”ŒëŸ¬ì‹œê°€ ìë™ í˜¸ì¶œ
-  í”ŒëŸ¬ì‹œë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë³€ê²½ ë‚´ìš©ì„ SQLë¡œ ì „ë‹¬í•˜ê³  íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•´ì•¼ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ì´ ëœë‹¤.
-  ê·¸ë˜ì„œ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ ìë™ìœ¼ë¡œ í”ŒëŸ¬ì‹œë¥¼ í˜¸ì¶œí•œë‹¤.
3. JPQL ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ í”ŒëŸ¬ì‹œê°€ ìë™ í˜¸ì¶œ
- ë§Œì•½ memeberA, memeberB, memeberCë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥(`em.persist(ë©¤ë²„)`)í–ˆëŠ”ë°, í”ŒëŸ¬ì‹œ ì—†ì´ ë°”ë¡œ JPQLë¬¸ì„ ë‚ ë¦¬ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
```java
em.creqteQuery('select m from Member m', Member.class);
```
- ì„¸ ì—”í‹°í‹°ì— ëŒ€í•œ ì •ë³´ëŠ” ì•„ì§ DBì— ë°˜ì˜ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì¡°íšŒë˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.
- ê·¸ë˜ì„œ JPQL ì‹¤í–‰ ì‹œ í”ŒëŸ¬ì‹œê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œëœë‹¤.
- ë‹¨, ì‹ë³„ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” `find()` ë©”ì„œë“œ ì‹¤í–‰ ì‹œì—ëŠ” í”ŒëŸ¬ì‹œê°€ í˜¸ì¶œë˜ì§€ ì•ŠëŠ”ë‹¤.    **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•´ì„œ ê·¸ëŸ°ê°€?**
---

#### ì¤€ì˜ì† ìƒíƒœ(detached)ì˜ ì—”í‹°í‹° ğŸ§¡
-ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ë˜ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ë˜ëŠ” ê²ƒì„ ì¤€ì˜ì† ìƒíƒœë¼ê³  í•œë‹¤.
- 3ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì¤€ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
1. íŠ¹ì • ì—”í‹°í‹°ë§Œ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜ : `em.detach(ì—”í‹°í‹°)`  -> 1ì°¨ ìºì‹œì™€ SQL ì“°ê¸° ì €ì¥ì†Œì— ìˆëŠ” ì •ë³´ ëª¨ë‘ ì‚­ì œ
2. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™” : `em.clear()`
3. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œ : `em.close()`
- íŠ¹ì§•
1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì„ í•˜ë‚˜ë„ ì§€ì›ë°›ì§€ ëª»í•œë‹¤. (1ì°¨ ìºì‹œ, ì“°ê¸° ì§€ì—°, ë³€ê²½ ê°ì§€, ì§€ì—° ë¡œë”©)
2. (ë¹„ì˜ì† ìƒíƒœì™€ ë‹¬ë¦¬) ì‹ë³„ì ê°’ì€ ê°€ì§€ê³  ìˆë‹¤. (ì´ë¯¸ í•œë²ˆ ì˜ì† ìƒíƒœì˜€ìœ¼ë¯€ë¡œ)
3. ì§€ì—° ë¡œë”©ì€ ì‹¤ì œ ê°ì²´ ëŒ€ì‹  í”„ë¡ì‹œ ê°ì²´ë¥¼ ë¡œë”©í•´ë‘ê³  í•´ë‹¹ ê°ì²´ë¥¼ ì‹¤ì œë¡œ ì‚¬ìš©í•  ë•Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ë²•ì¸ë°,
ì¤€ ì˜ì† ìƒíƒœëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë”ì´ìƒ ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì§€ì—° ë¡œë”© ì‹œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
---

#### ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•œ ê°ì²´ì™€ í…Œì´ë¸” ë§¤í•‘ ğŸ’œ
- JPAëŠ” ì—”í‹°í‹° ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ê¸°ë³¸ ìƒì„±ìë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ë§Œì•½ ìƒì„±ìë¥¼ í•˜ë‚˜ ì´ìƒ ë§Œë“œëŠ” ê²½ìš° ê¸°ë³¸ ìƒì„±ìë¥¼ ì§ì ‘ ë§Œë“¤ì–´ ë†”ì•¼í•œë‹¤. (`public` ë˜ëŠ” `protected`)
- **DB ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„±** ì†ì„±ì€ ìš´ì˜í™˜ê²½ë³´ë‹¤, í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ë‚˜ ì—”í‹°í‹°ì™€ í…Œì´ë¸”ì„ ì–´ë–»ê²Œ ë§¤í•‘í•´ì•¼í•˜ëŠ”ì§€ í•™ìŠµí•˜ëŠ” ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì. (í›Œë¥­í•œ í•™ìŠµ ë„êµ¬!)
  - create, create-drop, update, validate, none 
- ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ì„ ê±¸ì–´ì£¼ëŠ” `uniqueConstraints` ì†ì„±
  - DDL ìƒì„± ì‹œ ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ì´ ì¶”ê°€ëœë‹¤.
```java
@Table(name="MEMBER", uniqueConstraints = {@UniqueConstraint(
  name = "NAME_AGE_UNIQUE",
  columnNames = {"NAME", "AGE"} )})
```
ìƒì„±ëœ DDL
```sql
ALTER TABLE MEMBER ADD CONSTRAINT NAME_AGE_UNIQUE UNIQUE (NAME, AGE)
```
---

#### ê¸°ë³¸í‚¤ ì§ì ‘ í• ë‹¹ ì „ëµ ğŸ’™
`@Id` ë¡œ ë§¤í•‘í•˜ì—¬ ê¸°ë³¸ í‚¤ë¥¼ ì§ì ‘ í• ë‹¹í•  ìˆ˜ ìˆë‹¤.
ì ìš© ê°€ëŠ¥í•œ íƒ€ì…ì€ ì•„ë˜ì™€ ê°™ë‹¤.
- ìë°” ê¸°ë³¸í˜•
- ìë°” Wrapper í˜•
- String
- java.util.Date
- java.sql.Date
- java.math.BigDecimal
- java.math.BigInteger
---

### IDENTITY ì „ëµê³¼ SEQUENCE ì „ëµ ğŸ¤
```
IDENTITY ì „ëµì€ ë°ì´í„°ë¥¼ DBì— INSERTí•œ í›„ ê¸°ë³¸ í‚¤ ê°’ì„ ì¡°íšŒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì—, ì¶”ê°€ë¡œ DBë¥¼ ì¡°íšŒí•´ì„œ ì—”í‹°í‹°ì— ì‹ë³„ì ê°’ì„ í• ë‹¹í•  ìˆ˜ ìˆì—ˆë‹¤. 
í•˜ì§€ë§Œ JDBC3ì— ì¶”ê°€ëœ `Statement.getGeneratedKeys()`ë¥¼ ì‚¬ìš©í•˜ë©´ ë°ì´í„° ì €ì¥ê³¼ ë™ì‹œì— ìƒì„±ëœ ê¸°ë³¸í‚¤ ê°’ë„ ì–»ì–´ì˜¬ ìˆ˜ ìˆì–´ í•œë²ˆë§Œ í†µì‹ í•  ìˆ˜ ìˆê²Œ ëœë‹¤.
```
ì—”í‹°í‹°ê°€ ì˜ì† ìƒíƒœê°€ ë˜ë ¤ë©´ ì‹ë³„ìê°€ ë°˜ë“œì‹œ í•„ìš”í•˜ë¯€ë¡œ em.persist()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ì¦‰ì‹œ INSERT SQLì´ dbì— ì „ë‹¬ë˜ì–´ ì‹ë³„ìë¥¼ ì–»ëŠ”ë‹¤. ì¦‰, ì“°ê¸° ì§€ì—°ì´ ë™ì‘í•˜ì§€ ì•ŠëŠ” ì „ëµì´ë‹¤.

---
### ë³€ê²½ê°ì§€ì™€ ë³‘í•©(merge)
> JPAì—ì„œ ê¶Œì¥í•˜ëŠ” best practiceëŠ” **ë³€ê²½ê°ì§€**ì´ë‹¤.
1. ë³€ê²½ê°ì§€ë¥¼ í†µí•œ JPAì˜ DB ìˆ˜ì •
```java
@Autowired
EntityManager em;

Book book = em.find(Book.class, 1L);
book.setName("ì´ë¦„ ë°”ê¿”ì¹˜ê¸°");
// íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€(dirty checking)ê°€ ë°œìƒí•˜ì—¬ dbì— update ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ê³  ì—”í‹°í‹°ë¥¼ ë³€ê²½í•œë‹¤.
```

ì¤€ì˜ì† ì—”í‹°í‹°ì¼ ë•ŒëŠ” ì–´ë–»ê²Œ ë ê¹Œ?
- ì—”í‹°í‹° ì»¨í…ìŠ¤íŠ¸ê°€ ë”ì´ìƒ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì—”í‹°í‹°
- ì¤€ì˜ì†?<br>
  update ë©”ì„œë“œì—ì„œ Bookì´ë¼ëŠ” ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ì§€ë§Œ id, name, ë“±ì„ ì„¸íŒ…í•œë‹¤. ì´ë•Œ ì‹ë³„ì(id)ë¥¼ ì„¸íŒ…í•œë‹¤ëŠ” ê²ƒì€ ì´ë¯¸ dbì— í•œë²ˆ ì €ì¥ì´ ë˜ì—ˆë˜ ì—”í‹°í‹°ë¼ëŠ” ì˜ë¯¸.
- ê²°êµ­ ìƒˆ ì—”í‹°í‹°ë¥¼ ìƒì„±í•œ ê²ƒì´ê¸° ë•Œë¬¸ì— setXXXë§Œ í•œë‹¤ê³  í•´ì„œ JPAê°€ ë³€ê²½ì„ ê°ì§€í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì¤€ì˜ì† ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²• 2ê°€ì§€
1. ë³€ê²½ ê°ì§€(dirty checking) ê¸°ëŠ¥ ì‚¬ìš©
- `find()` persistë¡œ ì˜ì†ì„± ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì°¾ì•„ì„œ setXXXí•˜ê³  transactionì´ ì»¤ë°‹í•˜ëŠ” ê²½ìš°, JPAëŠ” ë³€ê²½ì„ ê°ì§€í•˜ì—¬ flushë¥¼ ë‚ ë¦°ë‹¤.
- flushë¥¼ ë‚ ë¦¬ë©´, ë°”ë€ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ì—¬ dbì— ì—…ë°ì´íŠ¸ë¥¼ ë³´ë‚´ëŠ” ê²ƒ.
2. ë³‘í•©(merge) ì‚¬ìš©
- ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥
- ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ê°’ìœ¼ë¡œ **ëª¨ë‘** êµì²´í•œë‹¤.
  - ë³‘í•©ì€ ëª¨ë“  ì†ì„±ì´ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì—, ë³‘í•© ì‹œ ê°’ì´ ì—†ìœ¼ë©´ `null`ë¡œ ì—…ë°ì´íŠ¸ ëœë‹¤.   -> ì‚¬ìš©í•˜ì§€ ë§ì
```java
@Transactional
void update(Item param) {
    Item mergeItem = em.merge(param);
}
```


## ì°¸ê³ 
### 1. ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ëŠ” ì‘ì—…ì€ ì—”í‹°í‹° í´ë˜ìŠ¤ ë‚´ì— í•˜ë‚˜ì˜ ë©”ì„œë“œë¥¼ ìƒì„±í•´ ì§„í–‰í•œë‹¤.
> ì˜ˆì œ
> ```java
> class Entity {
> private int stockCnt;
> 
>    public void addStockCnt() {
>      stockCnt++;
>    }
> }
> ```

## 2. ì„œë¹„ìŠ¤ ê³„ì¸µ ì—­í• ì— ë”°ë¥¸ íŒ¨í„´: ë„ë©”ì¼ ëª¨ë¸ íŒ¨í„´ vs íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´
> ë„ë©”ì¸ ëª¨ë¸(Domain Model) íŒ¨í„´ 
- ë„ë©”ì¸ì´ í–‰ë™(behavior)ê³¼ ë°ì´í„°(data)ë¥¼ í†µí•©í•˜ì—¬ ê°–ê³  ìˆë‹¤. (http://martinfowler.com/eaaCatalog/domainModel.html)
- ì„œë¹„ìŠ¤ ê³„ì¸µì€ ë‹¨ìˆœíˆ ì—”í‹°í‹°ì— í•„ìš”í•œ ìš”ì²­ì„ ìœ„ì„í•˜ëŠ” ì—­í• ë§Œ í•œë‹¤. 
- ì—”í‹°í‹°ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°€ì§„ë‹¤.
- ê°ì²´ ì§€í–¥ì˜ íŠ¹ì„±ì„ ì ê·¹ í™œìš©í•˜ëŠ” ë°©ì‹
> íŠ¸ëœì­ì…˜ ìŠ¤í¬ë¦½íŠ¸(Transaction Script) íŒ¨í„´ (http://martinfowler.com/eaaCatalog/transactionScript.html)
- í”„ë Œì œí…Œì´ì…˜ìœ¼ë¡œë¶€í„° ì˜¤ëŠ” ë‹¨ì¼ ìš”ì²­ì„ ë‹¤ë£¨ëŠ” ê°ê°ì˜ í”„ë¡œì‹œì €ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì¡°ì§í™”í•œë‹¤.
  - ê° íŠ¸ëœì­ì…˜ì´ ìì‹ ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê°–ê³  ìˆê³ , í•˜ìœ„ ì‘ì—…ì´ ìˆì„ ê²½ìš°, í•˜ìœ„ í”„ë¡œì‹œì €ë¡œ ë‚˜ëˆŒ ìˆ˜ë„ ìˆë‹¤.
- ë„ë©”ì¸ ëª¨ë¸ íŒ¨í„´ê³¼ ë°˜ëŒ€ë¡œ, ì—”í‹°í‹°ì—ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ê±°ì˜ ì—†ë‹¤.
- ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ëŒ€ë¶€ë¶„ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•œë‹¤.

### 3. ë™ì ì¿¼ë¦¬ ìƒì„± ë°©ë²• 3ê°€ì§€
1. JPQL : Stringìœ¼ë¡œ ë™ì ì¿¼ë¦¬ ìƒì„±í•˜ëŠ” ë°©ë²•. ì»´íŒŒì¼ ì²´í¬ê°€ ë˜ì§€ ì•Šì•„ ë²„ê·¸ê°€ ë°œìƒí•˜ê¸° ì‰½ë‹¤.
2. JPA Criteria : JPA í‘œì¤€ìŠ¤í™. Javaì½”ë“œë¡œ JPQLì„ ìƒì„±í•˜ë„ë¡ ë§Œë“¤ì–´ì£¼ëŠ” í´ë˜ìŠ¤ ëª¨ìŒ. ìœ ì§€ë³´ìˆ˜ì„±ì´ í˜„ì €íˆ ë–¨ì–´ì ¸ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ë”± Criteriaë¥¼ ì´ìš©í•œ ì½”ë“œë¥¼ ë´¤ì„ ë•Œ JPQLì´ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì§€ëŠ”ì§€ íŒŒì•…í•˜ê¸° ì–´ë µë‹¤.
3. QueryDSL(ğŸ’«ê¶Œê³ ) : ë™ì  ë¿ë§Œì•„ë‹ˆë¼ ì •ì ì¿¼ë¦¬ë„ ìƒì„±í•´ì¤„ ìˆ˜ ìˆìŒ. ì‹¤ë¬´ì—ì„œ ì ‘í•˜ëŠ” ë³µì¡í•œ ì¿¼ë¦¬ ë˜í•œ ê°€ëŠ¥í•˜ë‹¤.

### 4. ì‹¤ë¬´ì—ì„œëŠ” JPAë§Œìœ¼ë¡œ í•´ê²°ë˜ì§€ ì•Šê³ , JPA + JPQLì„ ì§ì ‘ ì´ìš©í•´ì„œ ì¿¼ë¦¬ë¥¼ ì§œì•¼í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.
ì˜í•œë‹˜: ì‹¤ë¬´ì—ì„œëŠ” Spring + JPA + Spring JPA + QueryDSL ë¬¶ìŒ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©
ë˜í•œ Spring Data Jpaì—ë„ ì œì•½ì´ ìˆê¸° ë•Œë¬¸ì—, í•œê³„ë¥¼ ì•Œê³  ì‚¬ìš©í•´ì•¼ í•œë‹¤.
ì‹¤ë¬´ì—ì„œëŠ” ì‚¬ìš©í•˜ë©´ ë§¤ìš° ë‹¨ìˆœí•´ì§€ëŠ” ì¢‹ì€ ê¸°ëŠ¥ì´ì–´ë„ ìœ„ ê°™ì€ ë¬¸ì œë¡œ ì‚¬ìš©í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.

### 5. ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ 1:N ê´€ê³„ì˜ í…Œì´ë¸”ë¼ë¦¬ joiní•˜ë©´ Nì¸ í…Œì´ë¸”ì˜ ë°ì´í„° ê°¯ìˆ˜ì— ë§ì¶°ì„œ ë°ì´í„°ê°€ ì¡°íšŒëœë‹¤.
ì£¼ë¬¸(Order)ì„ í•œ ë²ˆ í•  ë•Œ ë‘ê°œì˜ ì•„ì´í…œ(OrderItem)ì„ êµ¬ë§¤í–ˆë‹¤. ë‘ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì„œ ì¡°íšŒí•˜ë©´?
order_id=2ì¸ OrderëŠ” 1ê°œì˜ ë°ì´í„°ì´ì§€ë§Œ OrderItemì€ 2ê°œ(order_item_id=2,3)ì´ê¸° ë•Œë¬¸ì— order_id=2ì¸ Order ë°ì´í„° 1ê°œê°€ 2ê°œë¡œ ì¤‘ë³µ ì¡°íšŒëœë‹¤.
ê²°ê³¼ ì˜ˆì‹œ)
```
order_id  order_item_id
   2            2
   2            3
```

### 6. ì¼ëŒ€ë‹¤ ê´€ê³„ì—ì„œ ì»¬ë ‰ì…˜ íŒ¨ì¹˜ ì¡°ì¸ì€ 1ê°œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì¦‰, 1:N:M ê´€ê³„ë¡œ 2ê°œ ì´ìƒì˜ íŒ¨ì¹˜ì¡°ì¸ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
ë°ì´í„°ê°€ ì¤‘ë³µë˜ê¸°ë„ í•˜ì§€ë§Œ, ì •í•©ì„±ì´ ì•ˆ ë§ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

### 7.yml ì„¤ì • íŒŒì¼ì— ì˜µì…˜ `spring.jpa.properties.hibernate.default_batch_fetch_size`ê¹Œì§€ ì„¤ì •í•˜ë©´, ì¼ëŒ€ë‹¤ ê´€ê³„ë¡œ ì¸í•œ ì§€ì—° ë¡œë”© ì¡°íšŒ ì‹œ ì§€ì •í•œ ì‚¬ì´ì¦ˆë§Œí¼ pk ê¸°ì¤€ in ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì„œì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

ë§Œì•½ ë°ì´í„°ê°€ 1000ê°œ ìˆê³ , `default_batch_fetch_size=100`ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤ë©´ ì´ 10ë²ˆì˜ ì¿¼ë¦¬ë§Œ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.
í˜„ì¬ ì˜ˆì œì—ì„œëŠ” ë°ì´í„° ê°¯ìˆ˜ê°€ ëª¨ë‘ 100ê°œ ì´í•˜ì´ê¸° ë•Œë¬¸ì— ì¼ëŒ€ë‹¤ ê´€ê³„ì¸ ê°ì²´ ì¡°íšŒ ì‹œ 1:1:1ë¡œ ì¿¼ë¦¬ê°€ ì „ì†¡ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
ê²°êµ­ ì¼ëŒ€ë‹¤ ê´€ê³„ì—ì„œ 1:N:M -> 1:1:1ë¡œ ì„±ëŠ¥ì„ ìµœì í™”í•œ ê²ƒì´ë‹¤.
```sql
-- order_item ì¡°íšŒ ì‹œ pk(order_id)ë¡œ in ì¿¼ë¦¬ ì¡°íšŒ 
select orderitems0_.order_id as order_id5_5_1_, orderitems0_.order_item_id as order_it1_5_1_, orderitems0_.order_item_id as order_it1_5_0_, orderitems0_.count as count2_5_0_, orderitems0_.item_id as item_id4_5_0_, orderitems0_.order_id as order_id5_5_0_, orderitems0_.order_price as order_pr3_5_0_ from order_item orderitems0_ where orderitems0_.order_id in (4, 11);
-- item ì¡°íšŒ ì‹œ pk(item_id)ë¡œ in ì¿¼ë¦¬ ì¡°íšŒ 
select item0_.item_id as item_id2_3_0_, item0_.name as name3_3_0_, item0_.price as price4_3_0_, item0_.stock_quantity as stock_qu5_3_0_, item0_.artist as artist6_3_0_, item0_.etc as etc7_3_0_, item0_.author as author8_3_0_, item0_.isbn as isbn9_3_0_, item0_.actor as actor10_3_0_, item0_.director as directo11_3_0_, item0_.dtype as dtype1_3_0_ from item item0_ where item0_.item_id in (2, 3, 9, 10);
```

ì¶”ê°€) ë””í…Œì¼í•˜ê²Œ ë°°ì¹˜ ì‚¬ì´ì¦ˆ ì„¤ì •í•˜ë ¤ë©´, `@BatchSize` ì• ë…¸í…Œì´ì…˜ ì‚¬ìš©í•˜ì.
```java
    @BatchSize(size = 1000)
    @OneToMany(mappedBy="order", cascade= CascadeType.ALL)
    private List<OrderItem> orderItems = new ArrayList<>();
```   

> ì£¼ì˜í•  ì !!!<br>
`default_batch_fetch_size` ì˜ í¬ê¸°ëŠ” ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¥¼ ê³¨ë¼ì•¼ í•˜ëŠ”ë°, 100~1000 ì‚¬ì´ë¥¼ ê¶Œì¥í•œë‹¤.<br>
ì–´ë–¤ dbëŠ” inì ˆ íŒŒë¼ë¯¸í„° ìˆ˜ë¥¼ ìµœëŒ€ 1000ê¹Œì§€ ì œí•œí•˜ëŠ” ê²½ìš°ë„ ìˆê¸° ë•Œë¬¸ì´ë‹¤.<br>
=> sizeê°€ í´ìˆ˜ë¡, ì¿¼ë¦¬ ìˆ˜ëŠ” ì¤„ì§€ë§Œ í•œë²ˆì— 1000ê°œë¥¼ dbì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì „ë‹¬í•˜ë¯€ë¡œ dbì— ìˆœê°„ ë¶€í•˜ê°€ ë¬¸ì œë  ìˆ˜ ìˆê³ <br>
=> sizeê°€ ì‘ì„ìˆ˜ë¡, ì¿¼ë¦¬ ìˆ˜ê°€ ë§ì•„ì§„ë‹¤ëŠ” ë¬¸ì œê°€ ìˆë‹¤.<br>
ì–´ë–»ê²Œ í•˜ë“  ì „ì²´ ë°ì´í„°ë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ì•¼ í•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ì˜ ì‚¬ìš©ëŸ‰ì€ ë™ì¼í•˜ë‹¤. ê²°êµ­ dbë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¶€í•˜ë¥¼ ì–´ëŠì •ë„ê¹Œì§€ ê²¬ë”œ ìˆ˜ ìˆëƒì— ë”°ë¼ ì¡°ì •í•´ì•¼ í•œë‹¤.